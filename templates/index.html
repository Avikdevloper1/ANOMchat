<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#020617">
    <title>ANOM // MOBILE SECURE</title>
    
    <!-- Core Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        bg: '#020617', // Slate 950
                        surface: '#0f172a', // Slate 900
                        border: '#1e293b', // Slate 800
                        primary: '#3b82f6', // Blue 500
                        accent: '#22c55e', // Green 500
                        danger: '#ef4444' // Red 500
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* Mobile Enhancements */
        body { background-color: #020617; color: #f8fafc; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Glassmorphism */
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.05); }
        .glass-panel { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.08); }

        /* Animations */
        .page-enter { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile Input Fixes */
        input, button { -webkit-tap-highlight-color: transparent; }
        input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }
    </style>
</head>
<body>

<div id="root"></div>

{% raw %}
<script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const socket = io(); 

    // --- ICONS (Optimized SVGs) ---
    const Icons = {
        Logo: () => <svg className="w-8 h-8 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
        Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16m-7 6h7" /></svg>,
        Back: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>,
        Send: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>,
        User: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
        Lock: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>,
        Bell: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
        Plus: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
        Chat: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>,
        Alert: () => <svg className="w-16 h-16 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
    };

    // --- VPN SECURITY GUARD ---
    const VPNGuard = ({ children }) => {
        const [status, setStatus] = useState('CHECKING');

        useEffect(() => {
            const check = async () => {
                try {
                    const r = await fetch('/api/vpn_check');
                    const d = await r.json();
                    setStatus(d.secure ? 'SAFE' : 'UNSAFE');
                } catch { setStatus('UNSAFE'); }
            };
            check();
            const int = setInterval(check, 5000);
            return () => clearInterval(int);
        }, []);

        if(status === 'CHECKING') return (
            <div className="h-screen w-full flex flex-col items-center justify-center bg-bg">
                <div className="w-10 h-10 border-2 border-primary border-t-transparent rounded-full animate-spin"></div>
                <div className="mt-4 text-xs font-mono text-gray-500 tracking-widest">VERIFYING CONNECTION...</div>
            </div>
        );

        if(status === 'UNSAFE') return (
            <div className="h-screen w-full flex flex-col items-center justify-center bg-bg p-6 text-center relative overflow-hidden">
                <div className="absolute inset-0 bg-red-900/10 animate-pulse-slow pointer-events-none"></div>
                <Icons.Alert />
                <h1 className="text-2xl font-bold mt-6 text-white tracking-widest">SECURITY BREACH</h1>
                <div className="h-px w-16 bg-danger my-6 opacity-50"></div>
                <p className="text-gray-400 text-sm max-w-xs leading-relaxed font-mono">
                    UNSECURED NETWORK DETECTED.<br/>
                    ANOM PROTOCOL REQUIRES VPN.<br/>
                    CONNECTION TERMINATED.
                </p>
                <div className="mt-8 px-4 py-2 bg-danger/10 border border-danger/20 text-danger font-mono text-xs rounded">
                    ERR_ISP_LEAK_DETECTED
                </div>
            </div>
        );

        return children;
    };

    // --- APP LOGIC ---
    const App = () => {
        const [view, setView] = useState('LANDING'); // LANDING, AUTH, DASHBOARD
        const [user, setUser] = useState(null);
        
        // Chat State
        const [friends, setFriends] = useState([]);
        const [activeChat, setActiveChat] = useState(null);
        const [msgs, setMsgs] = useState({});
        
        // Notifications
        const [notifs, setNotifs] = useState([]);
        const [showNotifs, setShowNotifs] = useState(false);

        // Mobile Specific State
        const [mobileView, setMobileView] = useState('LIST'); // LIST or CHAT
        
        const generateID = () => {
            const c = "0123456789ABCDEF";
            let r = ""; 
            for(let i=0; i<5; i++) r += c[Math.floor(Math.random()*c.length)]; 
            return "ID-" + r;
        };

        useEffect(() => {
            socket.on('friend_req', (data) => setNotifs(p => [...p, {type:'REQ', data}]));
            socket.on('chat_msg', (b) => {
                setMsgs(p => ({ ...p, [b.sender]: [...(p[b.sender]||[]), {sender:'THEM', text:b.text}] }));
            });
            return () => socket.off();
        }, []);

        const login = (pass) => {
            if(pass.length !== 16) return alert("Key must be 16 characters");
            const id = generateID();
            setUser({id});
            socket.emit('join', {room: id});
            setView('DASHBOARD');
        };

        const addFriend = (id) => {
            if(!id) return;
            socket.emit('friend_req', {target_id: id, sender_id: user.id});
            alert("Secure handshake initiated.");
        };

        const acceptFriend = (n) => {
            const fid = n.data.sender_id;
            setFriends(p => [...p, {id: fid}]);
            setNotifs(p => p.filter(x => x !== n));
            const room = [user.id, fid].sort().join('_');
            socket.emit('join', {room});
        };

        const send = (txt) => {
            if(!txt) return;
            const room = [user.id, activeChat.id].sort().join('_');
            setMsgs(p => ({ ...p, [activeChat.id]: [...(p[activeChat.id]||[]), {sender:'ME', text:txt}] }));
            socket.emit('chat_msg', { room, blob: {sender:user.id, text:txt} });
        };

        // --- SUB-COMPONENTS ---

        const AuthScreen = () => (
            <div className="min-h-screen flex items-center justify-center p-6 page-enter">
                <div className="w-full max-w-sm">
                    <div className="text-center mb-10">
                        <div className="inline-block p-4 rounded-full bg-surface border border-border mb-4"><Icons.Logo /></div>
                        <h2 className="text-xl font-bold tracking-widest text-white">AUTHENTICATE</h2>
                        <p className="text-gray-500 text-xs mt-2 font-mono">ENTER YOUR 16-DIGIT SESSION KEY</p>
                    </div>
                    
                    <div className="space-y-4">
                        <input id="keyIn" type="password" maxLength="16" placeholder="XXXX-XXXX-XXXX-XXXX" 
                            className="w-full bg-surface border border-border rounded-xl p-4 text-center text-lg font-mono tracking-widest text-white focus:border-primary transition-colors" />
                        
                        <button onClick={() => login(document.getElementById('keyIn').value)} 
                            className="w-full py-4 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary/20 hover:bg-blue-600 transition active:scale-95">
                            DECRYPT SESSION
                        </button>
                    </div>

                    <div className="mt-8 text-center">
                        <button className="text-xs text-gray-500 underline decoration-gray-700">Import Identity File</button>
                    </div>
                </div>
            </div>
        );

        const LandingScreen = () => (
            <div className="min-h-screen flex flex-col justify-between p-6 page-enter">
                <nav className="flex justify-between items-center py-4">
                    <div className="flex items-center gap-2 font-bold text-lg tracking-tighter"><Icons.Logo /><span className="text-white">ANOM</span></div>
                    <div className="text-xs font-mono text-primary animate-pulse">● SYSTEM ONLINE</div>
                </nav>

                <main className="text-center mb-10">
                    <h1 className="text-5xl font-bold text-white leading-tight mb-6">Invisibility<br/><span className="text-gray-600">by design.</span></h1>
                    <p className="text-gray-400 text-sm leading-relaxed max-w-xs mx-auto mb-8">
                        The world's most advanced zero-knowledge communication infrastructure. 
                        No logs. No traces. Just you and the network.
                    </p>
                    <button onClick={() => setView('AUTH')} className="w-full max-w-xs py-4 bg-white text-bg font-bold rounded-full shadow-xl hover:bg-gray-100 transition active:scale-95">
                        INITIALIZE
                    </button>
                </main>

                <footer className="grid grid-cols-3 gap-2 text-center text-[10px] text-gray-600 font-mono border-t border-border pt-6">
                    <div>AES-256</div>
                    <div>NO LOGS</div>
                    <div>VPN LOCK</div>
                </footer>
            </div>
        );

        const Dashboard = () => {
            // Mobile: If activeChat is set, show chat view, else list view
            const isMobileChat = activeChat && mobileView === 'CHAT';

            return (
                <div className="h-screen flex flex-col md:flex-row overflow-hidden bg-bg page-enter">
                    
                    {/* SIDEBAR / FRIEND LIST (Visible on Desktop OR Mobile List View) */}
                    <div className={`${isMobileChat ? 'hidden' : 'flex'} md:flex flex-col w-full md:w-80 border-r border-border bg-surface/50 h-full`}>
                        
                        {/* Header */}
                        <div className="h-16 flex items-center justify-between px-4 border-b border-border">
                            <div className="font-mono text-sm text-primary font-bold tracking-wider">{user.id}</div>
                            <div className="relative">
                                <button onClick={() => setShowNotifs(!showNotifs)} className="p-2 text-gray-400 hover:text-white relative">
                                    <Icons.Bell />
                                    {notifs.length > 0 && <span className="absolute top-2 right-2 w-2 h-2 bg-danger rounded-full"></span>}
                                </button>
                                {/* Notification Dropdown */}
                                {showNotifs && (
                                    <div className="absolute top-10 right-0 w-64 bg-surface border border-border rounded-xl shadow-2xl z-50 overflow-hidden">
                                        {notifs.length === 0 ? <div className="p-4 text-xs text-gray-500 text-center">No alerts</div> : 
                                            notifs.map((n,i) => (
                                                <div key={i} className="p-3 border-b border-border hover:bg-white/5">
                                                    <div className="text-[10px] text-primary font-bold mb-1">REQ INBOUND</div>
                                                    <div className="text-xs text-white mb-2 font-mono">{n.data.sender_id}</div>
                                                    <button onClick={() => acceptFriend(n)} className="w-full py-1.5 bg-primary text-white text-xs rounded font-bold">ACCEPT</button>
                                                </div>
                                            ))
                                        }
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Add Friend */}
                        <div className="p-4">
                            <div className="flex bg-bg border border-border rounded-lg overflow-hidden">
                                <input id="fAdd" type="text" placeholder="Add ID..." className="flex-1 bg-transparent p-3 text-sm text-white font-mono uppercase" />
                                <button onClick={() => {addFriend(document.getElementById('fAdd').value); document.getElementById('fAdd').value=''}} className="px-4 text-gray-400 hover:text-primary"><Icons.Plus /></button>
                            </div>
                        </div>

                        {/* Friend List */}
                        <div className="flex-1 overflow-y-auto px-2">
                            {friends.length === 0 && <div className="text-center mt-10 text-xs text-gray-600">No secure links established.</div>}
                            {friends.map(f => (
                                <div key={f.id} onClick={() => { setActiveChat(f); setMobileView('CHAT'); }} 
                                    className={`p-4 mb-2 rounded-xl cursor-pointer transition ${activeChat?.id === f.id ? 'bg-primary/10 border border-primary/20' : 'hover:bg-white/5 border border-transparent'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-gray-700 to-gray-900 flex items-center justify-center text-xs font-mono text-gray-300">
                                            {f.id.slice(-2)}
                                        </div>
                                        <div>
                                            <div className="text-sm font-bold text-white font-mono">{f.id}</div>
                                            <div className="text-[10px] text-green-500">● ENCRYPTED</div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* CHAT AREA (Visible on Desktop OR Mobile Chat View) */}
                    <div className={`${!isMobileChat ? 'hidden' : 'flex'} md:flex flex-col flex-1 bg-bg h-full relative`}>
                        
                        {!activeChat ? (
                            <div className="hidden md:flex flex-col items-center justify-center h-full text-gray-600">
                                <Icons.Lock />
                                <span className="mt-4 text-sm font-mono">SELECT A CHANNEL</span>
                            </div>
                        ) : (
                            <>
                                {/* Chat Header */}
                                <div className="h-16 flex items-center px-4 border-b border-border bg-surface/80 backdrop-blur-md sticky top-0 z-10">
                                    <button onClick={() => setMobileView('LIST')} className="md:hidden mr-4 text-gray-400">
                                        <Icons.Back />
                                    </button>
                                    <div className="flex-1">
                                        <div className="text-sm font-bold text-white font-mono tracking-wide">{activeChat.id}</div>
                                        <div className="text-[10px] text-primary">AES-256-GCM / 24H KEY</div>
                                    </div>
                                    <button className="text-gray-400 hover:text-white"><Icons.Menu /></button>
                                </div>

                                {/* Messages */}
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24 md:pb-4">
                                    {(msgs[activeChat.id]||[]).map((m,i) => (
                                        <div key={i} className={`flex ${m.sender === 'ME' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[80%] px-4 py-3 rounded-2xl text-sm leading-relaxed ${m.sender === 'ME' ? 'bg-primary text-white rounded-br-none' : 'bg-surface border border-border text-gray-200 rounded-bl-none'}`}>
                                                {m.text}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* Input Area */}
                                <div className="p-3 bg-surface border-t border-border safe-pb">
                                    <div className="flex items-center gap-2 bg-bg border border-border rounded-full px-4 py-2">
                                        <input id="msgIn" type="text" placeholder="Message..." 
                                            className="flex-1 bg-transparent text-sm text-white h-10"
                                            onKeyDown={(e) => {if(e.key==='Enter'){send(e.target.value); e.target.value=''}}} />
                                        <button onClick={() => {const el=document.getElementById('msgIn'); send(el.value); el.value=''}} 
                                            className="p-2 bg-primary rounded-full text-white shadow-lg shadow-primary/30">
                                            <Icons.Send />
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        return (
            <>
                {view === 'LANDING' && <LandingScreen />}
                {view === 'AUTH' && <AuthScreen />}
                {view === 'DASHBOARD' && <Dashboard />}
            </>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<VPNGuard><App /></VPNGuard>);
</script>
{% endraw %}

</body>
</html>
